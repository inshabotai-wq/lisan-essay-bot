module.exports = async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    const { topic, type, words, includeAyah } = req.body;
    if (!topic) {
        return res.status(400).json({ error: 'Topic is required' });
    }

    const GEMINI_API_KEY = process.env.GEMINI_KEY;

    // Style examples – keep these as plain strings
    const styleExamples = `1447 - المجلس الثالث
زُحَل نسس English ما Saturn كظظوائي ححهسس، فارسي زبان ما اهنو نام كَيوان ححهسس، ايم كظظوائي ححهسس كه سورج انسس مُشتري يعني Sun and Jupiter نا بعد مهوضضا ما مهوضضا كوكب زُحَل ححهسس... 
تاراؤ نا علم ما جه ماهر هوئي ححهسس اهنا نزديك زُحَل - taskmaster سي اولكهائي ححهسس، وقت انسس تجارب سي سيكهتا رهوو، تمام ذمھ داريو نسس لئي اُضضھوو انسس discipline راكهوو يه زُحَل سي سيكهوا ملسس ححهسس، 
Discipline سوطط ححهسس - تهذيب، اُردو ما نظم وضبط كسس ححهسس، هميشھ planning كري نسس، هدف راكهي نسس، challenges نو سامنو كري نسس، مواظبة سي كامو كرتا} رهوو انسس اْككسس برٌهتا} رهوو.
***
اسس عزيزو! رسول الله ني ايك وصية ححهسس، سكهامن ححهسس جه ما اْثث يه discipline نا اصول بيان كيدا ححهسس، يه وصية اْثث كونسس كرسس ححهسس كه اُسامة بن زيد نسس، اُسامة - زيد بن حارثة نا فرزند ححهسس، جه زيد - رسول الله نا ككود ليدا هوا فرزند تها، تو ككويا اُسامة اْثث نا فرزند نا فرزند ححهسس، اهنسس رسول الله discipline سكهاوسس ححهسس، تهذيب سكهاوسس ححهسس، رسول الله - اُسامة نسس فرماوسس ححهسس كه "عليك بطريق الجنة"، اسس اُسامة! تميطط جنة نا راستھ نسس لازم رهو، "واياك ان تختلج عنها"، تميطط اْ وات سي دٌرو كه تميطط جنة نا راستھ موكي نسس كوئي بهي حركة كرو ككرححھ ناهنا ما ناهني حركة بهي كيم نھ هوئي، اْنكهو نا ثثھرٌكوا ني مثل بهي كيم نھ هوئي - English ما اهنسس twitching كهسس ححهسس،
تو اْ مثل وصية كري نسس رسول الله - اُسامة نسس اعلى ما اعلى discipline سكهاوسس ححهسس، تهذيب سكهاوسس ححهسس كه تمارا ناهنا ما ناهنا عمل سي كه مهوضضا ما مهوضضا عمل لكك سككلا عملو تميطط شريعة مطابق كرو، اسلام نا دين مطابق كرو، خدا يه انسس خدا نا اولياء كرام يه جيم سكهايو ححهسس ايم كرو، يه مثل عمل كروا سي جنة نا راستھ ثثر ححلي سكائي ححهسس، اْ مثل discipline راكهي نسس سككلا عملو كرسو تو تمام بلاؤ سي تميطط بححي نسس رهسو.
***
صراط مستقيم ثثر ححلوو ككهنو سهل ححهسس، سيدنا المؤيد الشيرازي فرماوسس ححهسس كه: 
وكونه ممدا على سقر * احد من سيف ادق من شعر
صراط مستقيم ني ايك صفة سوطط ححهسس كه يه تلوار ني دهار كرتا بهي تيز ححهسس، يعني سوطط كه جه مثل تيز تلوار هر ححيز نسس كاثثي دسس ححهسس يه} مثل صراط مستقيم - جه حق نو راستھ ححهسس - يه تمام مشكلو نسس كاثثي دسس ححهسس، اهنا ثثر ححلنار سي هر دُشوارككي دور تهئي جائي ححهسس، 
هوسس صراط مستقيم ني بيجي صفة سوطط ححهسس كه يه بال كرتا بهي زيادة باريك ححهسس، يعني جنة نو راستھ - يه راستھ ثثر ححلنار ني زندككي نا هر امر ما، يهاطط لكك كه باريك ما باريك امر ما بهي اهنسس هداية دسس ححهسس كه تميطط اْم كرو، اْم نھ كرو، انسس ايم بهي هداية دسس ححهسس كه تميطط اْم نھ كري سكتا هوئي تو اْم كرو، يه بهي نھ كري سكتا هوئي تو اْم كرو، يعني ايم هداية دسس ححهسس كه شريعة ما ككهني وُسعة ححهسس، اهنا مطابق عمل كروو ككهنو سهل ححهسس.
***
جھ مثل شريعة جنة نو راستھ ححهسس، انسس صراط مستقيم ححهسس، تو شريعة ما جه روح نا مقام ما ححهسس  - يه سوطط كه حق نا صاحب ني ولاية انسس محبة، يه بهي جنة نو راستھ ححهسس انسس صراط مستقيم ححهسس، 
سيدنا عبد القادر نجم الدين - اْثث نا باواجي صاحب سيدنا طيّب زين الدين ني مدح ما عرض كرسس ححهسس:
ولايته معنى الصراط وانها * لعمري كما جاءت احد من الغر
حق نا داعي ني ولاية يه} صراط مستقيم ني معنى ححهسس، يه تلوار ني دهار كرتا تيز ححهسس، يعني سوطط كه جه شخص حق نا صاحب ني برابر جيم ولاية كروي جوئيسس ايم كرسسس، جيم محبة كروي جوئيسس ايم كرسسس تو اهنا سي تمام مشكلو دور تهئي جاسسس، اهنا سي سككلي مصيبتو ضضلي جاسسس، اْ  ولاية انسس محبة تيز تلوار ني مثل اهني سككلي محنتو نسس تورٌي ديسسس، جه مثل زياد{ الاسود محبة نا صراط مستقيم ثثر ححلي نسس اْيا تو اهني مشكلو انسس دُشوارككيو دور تهئي ككئي.
***
حق نا صاحب ني ولاية انسس محبة نو راستھ بال كرتا باريك ححهسس، يعني سوطط كه شريعة نا ناهنا سي مهوضضا لكك هر عمل نسس ولاية انسس محبة راكهي نسس} لئي اُضضھوو جوئيسس، تو} يه عمل قبول تهائي ححهسس، 
يھ} مثل دنيا نا هر عمل نسس بهي ولي الله ني محبة راكهي نسس لئي اُضضھوو جوئيسس، اهنا سبب يه عمل كروو سهل تهائي ححهسس، انسس ايمان نا لوككو ما سي ناهنا ما ناهنا شخص هوئي يا مهوضضا ما مهوضضا صاحب هوئي، سككلا} ولاية انسس محبة كري سكسس ححهسس، 
ولاية انسس محبة كروو كئي مشكل وات نتهي، ولي الله ني محبة كروو كتنو سهل ححهسس كه ايك رائي نا دانھ برابر محبة جنة ما ثثظظنححاوي دسس ححهسس، يه محبة نا سبب ولي الله جه بهي فرماوسس ححهسس يه لئي اُضضھوو ككهنو سهل تهئي جائي ححهسس، انسس اهنا سبب سككلا امور سهل تهائي ححهسس انسس هلاكي سي بححي جوائي ححهسس، 
اسس مارا دل ما وسناراؤ! تميطط جه اولياء كرام ني محبة كرو ححهو، اهنا ثثر ناز كري نسس 
مملوك اْل محمد تمنسس ثثوححهوطط ححهوطط كه تمنسس جه بهي ارشاد كروا ما اْوسس ححهسس سوطط يه لئي اُضضھوو تمارا واسطسس مشكل ححهسس كئي؟ سوطط يه اوامر لئي اُضضھوو تمارا فرزندو واسطسس مشكل ححهسس؟ خدا نا قسم! خدا نا قسم! كئي مشكل نتهي! غير واسطسس يه} امر ككهنو مشكل ححهسس، مككر تمارا واسطسس يه سهل ححهسس، كيم كه تمارا دلو ما اهوي محبة ثثختھ ححهسس كه جه نا سبب مشكلو سهل تهائي ححهسس،
ديكهو! تميطط هر امر نسس ككهني سهلائي سي "لبَّيك يا داعي الله" كهي نسس فورا اُضضھاؤ ححهو، جه مثل تميطط فيض الموائد البرهانية ني بركات ككهر ككهر ثثورا سال ثثظظنححاؤ ححهو، جه مثل تمارا ححهوضضا ححهوضضا فرزندو نسس جه سكهامن ديوا ما اْوسس ححهسس كه اْ ححيز استعمال كرو انسس اْ ححيز استعمال نھ كرو، تو سككلا ككهني سهلائي سي وات نسس دهيان ما لئي نسس عمل كري دسس ححهسس، جه مثل تميطط وياج انسس محرمات سي دور رهو ححهو، جه مثل تميطط سككلا اْثثس ما ايك بيسرا ني خبرككيري كرو ححهو، مواساة كرو ححهو، ايك بيسرا نسس مدد كرو ححهو، جه مثل تميطط نظافة نو خيال راكهي نسس تماري هر ححيز نسس ثثاك راكهو ححهو، جه مثل قراْن مجيد نا حفظ ني بركة سي مؤمنين نا ككهر ككهر اْباد تهئي رهيا ححهسس، انسس ككهنا اْباد تهاسسس ان شاء الله... يه مثل نا عملو لئي اُضضھوو محبة نا سبب سهل تهئي جائي ححهسس، خدا تمنسس اْ محبة نا دين ثثر باقي راكهجو.
***
مؤمنين ني جماعة! هوسس يه ذكر كريئسس كه محبة كرنار مؤمن واسطسس هر امر ما discipline راكهوو كئي طرح سهل تهائي ححهسس، 
رسول الله يه اُسامة نسس discipline راكهتا سكهايو كه تميطط هر وقت جنة نا راستھ نسس لازم رهو، تو اُسامة رسول الله نسس ثثوححهسس ححهسس كه رسول  الله اْثث فرماؤ ححهو كه جنة نا راستھ نسس لازم رهو، ايك حركة بهي يه راستھ نسس موكي نسس نھ كرو، تو اْثث منسس بتاويئسس كه جنة نا راستھ نسس قطع كروا واسطسس سهل ما سهل طريقة سوطط ححهسس؟ 
تو رسول الله فرماوسس ححهسس كه "الظمأ في الهواجر وكسر النفوس عن لذة الدنيا"، سخت ككرمي ني موسم ما ثثياسا رهوو انسس دنيا ني لذتو سي جانو نسس تورٌوو، 
اسس برادرو! غور كرو كه اثثن روزه كريئسس ححهسس تو فجرسس سحوري نا وقت ما سحوري لئيسس ححهسس، تھ بعد جه وقت ما روزه كروو جوئيسس تھ وقت ما} برابر روزه كريئسس ححهسس، حرام ححيزو سي اثثنا انككواؤ نسس روزه كراويئسس ححهسس، كهاوا ثثيوا سي انسس دنيا ني بيجي لذّتو سي دور رهيئسس ححهسس، انسس مغرب لكك صبر كريئسس ححهسس، انسس مغرب نا وقت نماز نا بعد ترت افطار كريئسس ححهسس، انسس يه مثل شهر رمضان المعظم نا تيس دن لكك هر روز برابر عمل كريئسس ححهسس، تو اْ مثل تيس دن لكك وقت نو خيال راكهي نسس ثثابندي سي روزه كروو مؤمن نسس عجب discipline سكهاوسس ححهسس، مككر اْ مثل روزه كرتي وقت مؤمن نسس ثثهلسس اهنا نفس نامية نسس انسس نفس حسّية نسس - جه ما الكك الكك قوّتو ححهسس - اهنسس تورٌوو ثثرٌسس ححهسس، تاكه روزه ما جمن تناول نھ كري لسس، روزه ما شهوتو سي دور رهسس انسس ككناهو سي دور رهسس، جو اهنا نفس نسس كَسر نظظيطط كرسس تو روزه نظظيطط كري سكسس، 
جھ مثل كوئي نسس برابر discipline ساتهسس هر روز exercise - كَسرَتْ كروي هوئي تو ثثهلسس اهنا جان نسس كَسر كروو ثثرٌسس ححهسس، اهنو جان اهنسس سُستي انسس اْلس كروا ثثر اْماده كرسسس، انسس اككر يه جان ني وات ماني ليسسس تو رياضة نسس discipline نا ساتهسس نظظيطط كري سكسس، 
تو discipline راكهوا واسطسس سهل ما سهل راستھ يه ححهسس كه مؤمن ثثهلسس اهني هوى نفسي نسس كَسر كرسس.
***
(ملا راجا قس ني ذكر نا مجرى ما فرمايو)
عجب هوى نفسي نسس تورٌوا سي discipline حاصل تهائي ححهسس، اْج تميطط سككلا دنيا نا جواهرات نسس، مال انسس دولة نسس موكي نسس، تمارا جانو نسس كَسر كري نسس، جه حقيقي نماز - يه سوطط كه دعوة ني مجالس، انسس جه مولى سي نماز باقي ححهسس اهني مجالس ما برابر وقت ثثر مواظبة نا ساتهسس حاضر تهاؤ ححهو، تو عجب تمارا discipline ني قدر ححهسس، خدا تمنسس اْ مثل discipline راكهنار باقي راكهجو.
***
اسس برادرو! رسول الله اْ وصية ما سوطط ارشاد كرسس ححهسس كه تميطط تمارا جان نسس تورٌي نسس، دنيا ني لذّتو سي دور رهي نسس، ككهنا روزه انسس عبادة كري نسس، discipline راكهوا نا بعد discipline راكهوا ما ككهنا بلند تهاؤ - تو تھ وقت تميطط ايم جانجو كه تمارا كرتا زيادة بلند اهوا صاحبو بهي ححهسس جه ني discipline عجب شان ني ححهسس، انسس يه سككلا حقيقة ما كون ححهسس كه خدا نا اولياء كرام، دعاة عظام، يه سككلا ني بلندي لكك كوئي ثثظظنححي نھ سكسس، 
تو رسول الله - اُسامة نسس سوطط سكهاوسس ححهسس كه كوئي شخص self-discipline حاصل كري نسس ككهنا بلند بهي تهئي جائي مككر اهنسس ايم} سمجهوو جوئيسس كه هجي اهنا كرتا بهي كوئي بلند صاحب ححهسس، 
جيم الله سبحانه قراْن مجيد ما فرماوسس ححهسس: "وفوق كل ذي علم عليم" هر عالـِم نا فوق ايك عالـِم ححهسس، حتى كه سككلا نا فوق ولي الله ححهسس انسس اهنا اوثثر خدا ححهسس، جه شخص اْ مثل تصوّر راكهسسس تو} يه تواضع راكهي سكسسس، انسس discipline راكهوا ما هجي محنة كرسسس، اككر كوئي ايم سمجهي ليسسس كه يه discipline ني نهاية لكك ثثظظنححي ككيا ححهسس تو اهما تكبّر اْوي جاسسس انسس اهني discipline موكائي جاسسس.
***
صحيح discipline يه ححهسس كه مؤمن ني قدر جتني بهي بلند تهائي مككر يه خدا انسس خدا نا ولي امام الزمان انسس ستر نا زمان ما اهنا دعاة مطلقين نسس بھولي نھ جائي، انسس هميشھ اهنا واسطسس تواضع كرسس، كه جه ني دعاء ني بركة سي انسس اهني نظرات سي اهنسس كاميابي انسس بلندي ملي ححهسس، 
اسس عزيزو! جه مُنعِم هوئي اهني هميشھ قدر كرتا رهوو جوئيسس، ايم تو نھ} بنسس كه اهني قدر نھ كروا نا بدل كوئي اهنا ثثر} تعدّي كري دسس. 
*** `;

    const typeDescription = {
        Expository: "Explains or informs objectively.",
        Descriptive: "Paints a vivid picture.",
        Analytical: "Breaks down and examines.",
        Narrative: "Tells a story.",
        Other: "Balanced style."
    };

    const ayahInstruction = includeAyah
        ? "Include at least one Quranic verse (with reference) and one authentic Hadith relevant to the topic."
        : "Do not include any Quranic verses or Hadith.";

    const openingInstruction = topic.includes("محبت") || topic.includes("mohabbat")
        ? "Start by describing worldly love, then transition to love for Aale Muhammad."
        : "";

    const systemPrompt = `
You are a master essay writer in **Lisan-ud-Dawat**. Write in pure Lisan-ud-Dawat (Arabic script, authentic vocabulary). All the exampales are style guides to learn fromand are not context to copy from. 
You know that lisa ud dawat has their diffrent alphabeta which are not in arabic,
 so you have understood it and leearn the launguage as it is.

## WORD COUNT
You MUST write at least ${words} words. Do NOT stop early.

## TASK
Write a **complete** essay on "${topic}" in **${type}** style.
${openingInstruction}

## STRUCTURE (no headings)
1. Muqaddama (introduction)
2. Bayan (body) – ${ayahInstruction}
3. Natijah (conclusion)

## LANGUAGE
- Pure Lisan-ud-Dawat: use words like "محبت" not "لَو".
- Style inspiration: ${styleExamples} (create new sentences).
- Do not mention Sahabah or Khalifas by name.

## OUTPUT
Only the essay text.
`;

    try {
        const maxTokens = Math.min(parseInt(words) * 2 + 500, 3000);

        const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: systemPrompt }]
                }],
                generationConfig: {
                    temperature: 0.85,
                    maxOutputTokens: maxTokens,
                    topP: 0.95,
                    topK: 40
                }
            })
        });

        const data = await response.json();

        if (!response.ok) {
            console.error('Gemini API error:', JSON.stringify(data, null, 2));
            return res.status(response.status).json({ error: data.error?.message || 'Gemini API error' });
        }

        const essay = data.candidates?.[0]?.content?.parts?.[0]?.text;

        if (essay) {
            res.status(200).json({ essay });
        } else {
            console.error('No essay in response:', data);
            res.status(500).json({ error: 'Failed to generate essay', details: data });
        }
    } catch (error) {
        console.error('API call failed:', error);
        res.status(500).json({ error: 'Server error', message: error.message });
    }
};
